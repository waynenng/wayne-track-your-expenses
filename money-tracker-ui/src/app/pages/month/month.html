<h2>Expenses</h2>

<!-- üîÅ Currency selector -->
<label>
  Currency:
  <select [ngModel]="currency" (ngModelChange)="onCurrencyChange($event)">
    <option value="RM">RM</option>
    <option value="$">$</option>
  </select>
</label>

<hr />

<button (click)="back()">‚Üê Back</button>

<h3>
  Total:
  {{ currency }}
  {{ getMonthlyTotal() | number:'1.2-2' }}
</h3>

<!-- ‚ûï Add Expense Form -->
<form (ngSubmit)="addExpense()" style="margin-bottom: 1rem">

  <input
    type="number"
    step="0.01"
    placeholder="Amount"
    [(ngModel)]="amount"
    name="amount"
    required
  />

  <input
    type="text"
    placeholder="Description"
    [(ngModel)]="description"
    name="description"
    required
  />

  <input
    type="date"
    [(ngModel)]="date"
    name="date"
    [min]="monthYear + '-' + (monthNumber | number:'2.0') + '-01'"
    [max]="monthYear + '-' + (monthNumber | number:'2.0') + '-31'"
    required
  />


  <!-- üìÇ Category selector -->
  <select [(ngModel)]="categoryId" name="categoryId" required>
    <option *ngFor="let c of categories" [value]="c.id">
      {{ c.name }}
    </option>

    <option value="__new__">‚ûï Add new category</option>
  </select>

  <div *ngIf="categoryId === '__new__'">
    <input
      type="text"
      placeholder="New category name"
      [(ngModel)]="newCategoryName"
      name="newCategoryName"
    />

    <button type="button" (click)="addCategory()">
      Save Category
    </button>

    <p *ngIf="categoryError" style="color:red;">
      {{ categoryError }}
    </p>
  </div>

  <button type="submit">Add Expense</button>
</form>

<label>
  Filter by category:
  <select [(ngModel)]="selectedCategoryId" (change)="applyCategoryFilter()">
    <option value="ALL">All categories</option>
    <option *ngFor="let c of categories" [value]="c.id">
      {{ c.name }}
    </option>
  </select>
</label>

<!-- üìä Expenses Table (FIXED: reactive + async pipe) -->
<table *ngIf="filteredExpenses.length > 0; else empty" border="1" cellpadding="8">
  <thead>
  <tr>
    <th>Date</th>
    <th>Description</th>
    <th>Category</th>
    <th>Amount</th>
  </tr>
  </thead>

  <tbody>
  <tr *ngFor="let e of filteredExpenses">
    <td>{{ e.date | date:'dd MMM yyyy' }}</td>
    <td>{{ e.description }}</td>
    <td>{{ getCategoryName(e.categoryId) }}</td>
    <td>{{ currency }} {{ e.amount | number:'1.2-2' }}</td>
  </tr>
  </tbody>
</table>

<ng-template #empty>
  <p>No expenses found.</p>
</ng-template>


