<h2>Your Expenses</h2>

<div class="header-actions">
  <button (click)="back()">Back Home</button>

  <h3 class="total">
    Total:
    {{ currency }}
    {{ getMonthlyTotal() | number:'1.2-2' }}
  </h3>
</div>

<!-- ðŸ” Top bar -->
<div class="top-bar">

  <label>
    Currency:
    <select
      [ngModel]="currency"
      (ngModelChange)="onCurrencyChange($event)"
    >
      <option value="RM">RM</option>
      <option value="$">$</option>
    </select>
  </label>

</div>

<!-- âž• Add Expense Form -->
<form (ngSubmit)="addExpense()" class="expense-form">

  <!-- ðŸ”¹ Main row -->
  <div class="expense-row">
    <input
      type="number"
      step="0.01"
      placeholder="Amount"
      [(ngModel)]="amount"
      name="amount"
      required
    />

    <input
      type="text"
      placeholder="Description"
      [(ngModel)]="description"
      name="description"
      required
    />

    <input
      type="date"
      [(ngModel)]="date"
      name="date"
      [min]="monthYear + '-' + (monthNumber | number:'2.0') + '-01'"
      [max]="monthYear + '-' + (monthNumber | number:'2.0') + '-31'"
      required
    />

    <!-- ðŸ“‚ Category selector -->
    <select [(ngModel)]="categoryId" name="categoryId" required>
      <option *ngFor="let c of categories" [value]="c.id">
        {{ c.name }}
      </option>
      <option value="__new__">âž• Add new category</option>
    </select>
  </div>

  <!-- âž• Inline new category (appears UNDER category only) -->
  <div
    class="new-category-row"
    *ngIf="categoryId === '__new__'"
  >
    <input
      type="text"
      placeholder="New category name"
      [(ngModel)]="newCategoryName"
      name="newCategoryName"
    />

    <button type="button" (click)="addCategory()">
      Save
    </button>
  </div>

  <p *ngIf="categoryError" class="error">
    {{ categoryError }}
  </p>

  <button type="submit" class="primary full-width">
    + Add Expense
  </button>

</form>

<!-- ðŸ” Filter -->
<label class="filter-row">
  Filter by category:
  <select
    [(ngModel)]="selectedCategoryId"
    (change)="applyCategoryFilter()"
  >
    <option value="ALL">All categories</option>
    <option *ngFor="let c of categories" [value]="c.id">
      {{ c.name }}
    </option>
  </select>
</label>

<!-- Expenses Table -->
<table
  *ngIf="filteredExpenses.length > 0; else empty"
  cellpadding="8"
>
  <thead>
  <tr>
    <th>Date</th>
    <th>Description</th>
    <th>Category</th>
    <th>Amount</th>
    <th></th>
  </tr>
  </thead>

  <tbody>
  <tr *ngFor="let e of filteredExpenses">

    <!-- DATE -->
    <td>
      <ng-container *ngIf="editingExpenseId !== e.id; else editDate">
        {{ e.date | date:'dd MMM yyyy' }}
      </ng-container>
      <ng-template #editDate>
        <input type="date" [(ngModel)]="editForm.date" />
      </ng-template>
    </td>

    <!-- DESCRIPTION -->
    <td>
      <ng-container *ngIf="editingExpenseId !== e.id; else editDesc">
        {{ e.description }}
      </ng-container>
      <ng-template #editDesc>
        <input type="text" [(ngModel)]="editForm.description" />
      </ng-template>
    </td>

    <!-- CATEGORY -->
    <td>
      <ng-container *ngIf="editingExpenseId !== e.id; else editCategory">
        {{ getCategoryName(e.categoryId) }}
      </ng-container>
      <ng-template #editCategory>
        <select [(ngModel)]="editForm.categoryId">
          <option *ngFor="let c of categories" [value]="c.id">
            {{ c.name }}
          </option>
        </select>
      </ng-template>
    </td>

    <!-- AMOUNT -->
    <td>
      <ng-container *ngIf="editingExpenseId !== e.id; else editAmount">
        {{ currency }} {{ e.amount | number:'1.2-2' }}
      </ng-container>
      <ng-template #editAmount>
        <input type="number" step="0.01" [(ngModel)]="editForm.amount" />
      </ng-template>
    </td>

    <!-- ACTIONS -->
    <td>
      @if (editingExpenseId !== e.id) {
      <button (click)="startEdit(e)">Edit</button>
      }

      @if (editingExpenseId === e.id) {
      <button (click)="saveEdit(e)">Save</button>
      <button (click)="cancelEdit()">Cancel</button>
      <button
        class="danger"
        (click)="deleteExpense(e.id!)"
      >
        Delete
      </button>
      }
    </td>

  </tr>
  </tbody>
</table>

<ng-template #empty>
  <p>No expenses found.</p>
</ng-template>
